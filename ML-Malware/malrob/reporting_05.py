# malrob/reporting_05.py
from __future__ import annotations

from dataclasses import dataclass
from pathlib import Path
from typing import Tuple

import numpy as np
import pandas as pd
import matplotlib.pyplot as plt


# ----------------------------
# Config / outputs
# ----------------------------
@dataclass
class ReportingPaths:
    results_dir: Path
    artifacts_dir: Path
    plots_dir: Path

    @classmethod
    def from_results_dir(cls, results_dir: Path, plots_subdir: str = "plots_05") -> "ReportingPaths":
        results_dir = Path(results_dir)
        artifacts_dir = results_dir.parent / "artifacts_adv"
        plots_dir = results_dir / plots_subdir
        plots_dir.mkdir(parents=True, exist_ok=True)
        return cls(results_dir=results_dir, artifacts_dir=artifacts_dir, plots_dir=plots_dir)


# ----------------------------
# Loaders
# ----------------------------
def load_global_summaries(results_dir: Path) -> pd.DataFrame:
    """
    Loads summary_fgsm.csv and summary_pgd.csv from results_dir and concatenates into df_global.
    Expected columns include:
      - attack, eps, fn_rate_nn_fixed, fn_rate_rf_fixed_transfer, nn_clean_thr, rf_clean_thr, n_mal, ...
    """
    results_dir = Path(results_dir)

    fgsm_path = results_dir / "summary_fgsm.csv"
    pgd_path = results_dir / "summary_pgd.csv"

    if not fgsm_path.exists():
        raise FileNotFoundError(f"Missing: {fgsm_path}")
    if not pgd_path.exists():
        raise FileNotFoundError(f"Missing: {pgd_path}")

    df_fgsm = pd.read_csv(fgsm_path)
    df_pgd = pd.read_csv(pgd_path)

    df_global = pd.concat([df_fgsm, df_pgd], ignore_index=True)

    # Normalize defensively
    if "attack" in df_global.columns:
        df_global["attack"] = df_global["attack"].astype(str).str.upper()
    if "eps" in df_global.columns:
        df_global["eps"] = df_global["eps"].astype(float)

    return df_global


def load_family_summary(results_dir: Path) -> pd.DataFrame:
    """
    Loads family_evasion_summary.csv from results_dir.
    Expected columns include:
      - attack, eps, family, model, fn_rate
    """
    results_dir = Path(results_dir)
    fam_path = results_dir / "family_evasion_summary.csv"
    if not fam_path.exists():
        raise FileNotFoundError(
            f"Missing required file: {fam_path}\n"
            "Run Notebook 04 first to generate family_evasion_summary.csv."
        )

    df_fam = pd.read_csv(fam_path)

    # Normalize defensively
    df_fam["attack"] = df_fam["attack"].astype(str).str.upper()
    df_fam["eps"] = df_fam["eps"].astype(float)
    df_fam["family"] = df_fam["family"].astype(str)
    df_fam["model"] = df_fam["model"].astype(str)

    return df_fam


# ----------------------------
# Tables
# ----------------------------
def build_headline_table(df_global: pd.DataFrame) -> pd.DataFrame:
    """
    Headline global table:
      mean NN FN rate and mean RF-transfer FN rate for each (attack, eps),
      plus transfer ratio RF/NN.
    """
    required = {"attack", "eps", "fn_rate_nn_fixed", "fn_rate_rf_fixed_transfer"}
    missing = required - set(df_global.columns)
    if missing:
        raise ValueError(
            f"df_global missing required columns: {sorted(missing)}\n"
            f"Available columns: {sorted(df_global.columns)}"
        )

    headline = (
        df_global
        .groupby(["attack", "eps"], as_index=False)
        .agg(
            nn_fn_rate=("fn_rate_nn_fixed", "mean"),
            rf_transfer_fn_rate=("fn_rate_rf_fixed_transfer", "mean"),
        )
        .sort_values(["attack", "eps"])
    )

    den = headline["nn_fn_rate"].replace(0, np.nan)
    headline["transfer_ratio_rf_over_nn"] = headline["rf_transfer_fn_rate"] / den
    return headline


def build_family_mean_table(df_fam: pd.DataFrame) -> pd.DataFrame:
    """
    Aggregates per-family FN rate over eps + attack, separated by model, and computes RF/NN ratio.
    Returns a wide table: family, NN, RF-transfer, transfer_ratio_rf_over_nn.
    """
    required = {"family", "model", "fn_rate"}
    missing = required - set(df_fam.columns)
    if missing:
        raise ValueError(
            f"df_fam missing required columns: {sorted(missing)}\n"
            f"Available columns: {sorted(df_fam.columns)}"
        )

    family_summary = (
        df_fam
        .groupby(["family", "model"], as_index=False)
        .agg(mean_fn_rate=("fn_rate", "mean"))
    )

    pivot_family = (
        family_summary
        .pivot(index="family", columns="model", values="mean_fn_rate")
        .reset_index()
    )

    for col in ["NN", "RF-transfer"]:
        if col not in pivot_family.columns:
            pivot_family[col] = np.nan

    den = pivot_family["NN"].replace(0, np.nan)
    pivot_family["transfer_ratio_rf_over_nn"] = pivot_family["RF-transfer"] / den

    pivot_family = pivot_family.sort_values("NN", ascending=False)
    return pivot_family


# ----------------------------
# Plots
# ----------------------------
def plot_global_nn_vs_rf_transfer(
    headline: pd.DataFrame,
    plots_dir: Path,
    filename: str = "global_nn_vs_rf_transfer_fgsm_pgd.png",
) -> Path:
    """
    Single panel plot with FGSM solid and PGD dashed (NN and RF-transfer).
    """
    plots_dir = Path(plots_dir)
    plots_dir.mkdir(parents=True, exist_ok=True)

    fig, ax = plt.subplots(figsize=(8, 5))

    for attack, style in [("FGSM", "-"), ("PGD", "--")]:
        sub = headline[headline["attack"] == attack].sort_values("eps")
        if sub.empty:
            continue

        ax.plot(
            sub["eps"], sub["nn_fn_rate"],
            marker="o", linestyle=style,
            label=f"NN ({attack})"
        )
        ax.plot(
            sub["eps"], sub["rf_transfer_fn_rate"],
            marker="x", linestyle=style,
            label=f"RF-transfer ({attack})"
        )

    ax.set_title("Global Targeted Evasion: NN vs RF-transfer")
    ax.set_xlabel("Epsilon (perturbation strength)")
    ax.set_ylabel("False Negative Rate (malware â†’ benign)")
    ax.grid(True, alpha=0.3)
    ax.legend()

    plt.tight_layout()

    out_path = plots_dir / filename
    fig.savefig(out_path, dpi=300, bbox_inches="tight")
    plt.show()

    return out_path


# ----------------------------
# Orchestrator
# ----------------------------
def run_reporting_05(
    *,
    results_dir: Path,
    plots_subdir: str = "plots_05",
    save_tables: bool = True,
) -> Tuple[pd.DataFrame, pd.DataFrame, Path]:
    """
    End-to-end:
      - load global summaries
      - load family summary
      - build headline + family mean tables
      - save CSVs (optional)
      - plot global figure
    Returns:
      headline_df, pivot_family_df, global_plot_path
    """
    paths = ReportingPaths.from_results_dir(results_dir, plots_subdir=plots_subdir)

    df_global = load_global_summaries(paths.results_dir)
    df_fam = load_family_summary(paths.results_dir)

    headline = build_headline_table(df_global)
    pivot_family = build_family_mean_table(df_fam)

    if save_tables:
        out_headline = paths.results_dir / "headline_global_nn_vs_rf_transfer.csv"
        headline.to_csv(out_headline, index=False)

        out_family = paths.results_dir / "family_mean_fn_rates_nn_vs_rf.csv"
        pivot_family.to_csv(out_family, index=False)

    plot_path = plot_global_nn_vs_rf_transfer(headline, paths.plots_dir)

    return headline, pivot_family, plot_path


__all__ = [
    "ReportingPaths",
    "load_global_summaries",
    "load_family_summary",
    "build_headline_table",
    "build_family_mean_table",
    "plot_global_nn_vs_rf_transfer",
    "run_reporting_05",
]