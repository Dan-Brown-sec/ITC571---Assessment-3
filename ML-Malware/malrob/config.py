from pathlib import Path

from malrob.bootstrap import ensure_repo_on_path
from malrob.config import RunPaths, RANDOM_STATE_DEFAULT
from malrob.data import make_ember_flat, make_ember_families_flat

# Ensure repo importability (only needed if not pip install -e .)
REPO_ROOT = ensure_repo_on_path(r"C:\ML-Malware1")

# ----------------------------
# 1) Single knobs
# ----------------------------
TARGET_PER_CLASS = 6000
SEED_X = RANDOM_STATE_DEFAULT

# Raw EMBER source location (jsonl)
EMBER_RAW_DIR = REPO_ROOT / "data" / "ember2018"

# ----------------------------
# 2) Derived standard paths
# ----------------------------
paths = RunPaths.build(repo_root=REPO_ROOT, target_per_class=TARGET_PER_CLASS)
SAVE_DIR = paths.repo_root / "datasets" / "ember2018"
SAVE_DIR.mkdir(parents=True, exist_ok=True)

print("REPO_ROOT:", paths.repo_root)
print("DATASET_TAG:", paths.dataset_tag)
print("EMBER_RAW_DIR:", EMBER_RAW_DIR)
print("SAVE_DIR:", SAVE_DIR)

# ----------------------------
# 3) Build datasets
# ----------------------------
binary_csv = make_ember_flat(
    ember_dir=EMBER_RAW_DIR,
    input_filename="test_features.jsonl",
    target_per_class=TARGET_PER_CLASS,
    save_dir=SAVE_DIR,
    feature_mode="full",
    prefix="ember_full",
    seed=SEED_X,
)

family_csv = make_ember_families_flat(
    ember_dir=EMBER_RAW_DIR,
    input_filename="test_features.jsonl",
    target_per_class=TARGET_PER_CLASS,
    save_dir=SAVE_DIR,
    feature_mode="full",
    family_key="avclass",
    prefix="ember_full",
    seed=SEED_X,
)

print("Binary dataset saved to:", binary_csv)
print("Family dataset saved to:", family_csv)